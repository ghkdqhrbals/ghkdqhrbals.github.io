---
title: "실시간 채팅방 구현(9) - (양방향 DB Sync with Kafka connector)"
categories:
  - 프로젝트
  - Spring
date: 2023-01-04 09:00:25 +0900
tags:
---
# INDEX
1. DB sync 시 고려할점
2. 어떻게 두 개의 master DB를 sync 해야할까?


앞서 연동에 추가할 부분이 있다. 채팅서비스를 두개로 실행하는데, 문제는 DB가 서로 독립이라는 점이다. 따라서 두 개중, 어느 DB가 INSERT/ALTER 등이 된다면 다른 DB도 같은 트랜젝션을 수행해야한다. 즉, 분산 DB이면서 서로 sync되도록 해야된다.
> 이렇게 DB를 따로 뗀 이유는 수평확장시키기 좋기 때문이다. 이러한 두 개의 DB 모두 master DB로 수행된다.

# 1. DB sync 시 고려할점
이 부분에서 고려할 점은 다음과 같다.
* 백업 DB처럼 단반향 sync가 아닌 양방향 sync 를 해야하기 때문에 서로 맞물리는 **무한루프를 조심**해야한다.
> 보통 Source/Target DB를 정하고 CDC(Change Data Capture)후 Sync를 하는경우가 대부분이다.
> 양방향 sync는 좀더 까다로운것 같다. 아래는 양방향에 있어 발생가능한 이슈 및 해결방법이다.
>
> Second, you'll need to make sure to **not propagate the same data change forth and back in an infinite loop**. One way of doing so could for instance be an **SMT(단일 메시지 변환) which you apply to both sources and which adds a Kafka Connect header property representing the "origin" of a given change**. In your sink connector, you'd then add that origin as an additional column to your data as you update it. The source connector on that side would then have to be set up (e.g. again using an SMT) to ignore all the changes which originate from replication, as opposed to actual data changes e.g. done by a business application.
>
> Issue from [https://groups.google.com/g/debezium/c/YS22DAgFXSc](https://groups.google.com/g/debezium/c/YS22DAgFXSc)


### 1-1. 여기서 SMT란?

> Single Message Transforms (SMTs) is a Kafka API that provides a simple interface for manipulating records as they flow through both the source and sink side of your data pipeline.
>
> reference [https://camel.apache.org/camel-kafka-connector/3.18.x/reference/transformers/index.html](https://camel.apache.org/camel-kafka-connector/3.18.x/reference/transformers/index.html)

위의 레퍼런스를 번역하자면 SMTs는 `source connector`->`sink connector` 로 sync할 때, 레코드의 칼럼명이나 value 등을 변경시켜서 전달해주는 kafka 편의기능 rest api 이다. 아래는 다양한 변환방법이다.

> Some common uses for transforms are:
>
>* [Renaming fields](https://docs.confluent.io/platform/current/connect/transforms/replacefield.html#replacefield)( 칼럼명 재정의 )
>* [Masking values](https://docs.confluent.io/platform/current/connect/transforms/maskfield.html#maskfield)( 특정 칼럼의 value를 **valid null**로 만듬 ex) {value} to 0 or "" or false )
>* Routing records to topics based on a value( cloud 에서는 안됨 )
>* [Converting or inserting timestamps into the record](https://docs.confluent.io/platform/current/connect/transforms/timestampconverter.html#timestampconverter)
>* [Manipulating keys, like setting a key from a field’s value](https://docs.confluent.io/platform/current/connect/transforms/valuetokey.html#description)( 카프카는 key를 통해 원하는 메세지를 가져올 수 있다. 이 방법은 특정 칼럼의 value를 key로 변환해주는 방법이다 )
>
> reference [https://www.confluent.io/blog/kafka-connect-single-message-transformation-tutorial-with-examples/?_ga=2.130915337.76772118.1672804235-1001218784.1670749352&_gac=1.191662808.1671423652.CjwKCAiAkfucBhBBEiwAFjbkr7Bq_5Npm8yLue-N4DKIv4hpPc44IdpcBYN3ITQzeAAdIkGX2Y5wJRoCBYIQAvD_BwE](https://www.confluent.io/blog/kafka-connect-single-message-transformation-tutorial-with-examples/?_ga=2.130915337.76772118.1672804235-1001218784.1670749352&_gac=1.191662808.1671423652.CjwKCAiAkfucBhBBEiwAFjbkr7Bq_5Npm8yLue-N4DKIv4hpPc44IdpcBYN3ITQzeAAdIkGX2Y5wJRoCBYIQAvD_BwE)

# 2. 어떻게 두 개의 master DB를 sync 해야할까?
필자는 Kafka connector을 이용하여 싱크를 맞추려한다. 그러기 위해서는 Kafka connector에 대한 이해가 바탕이 되어야한다.

## 2-1. Kafka connector란?
Kafka connector의 기본적인 플로우는 다음과 같다.
![img](../../assets/img/kafka/4.png)
1. RDB에 INSERT/UPDATE/ALTER 등 변경되는 트랜젝션이 실행되고 TXlog에 기록된다
2. Kafka Connector은 이를 읽고(CDC) Kafka의 Topic에 삽입한다

이 때 이 connector을 우리는 **source conenctor**이라고 부른다. 그리고 `Kafka ---> DB`를 연결시켜주는 connector은 **sink connector**이라고 부른다.

일단 먼저 Kafka source connector을 설정해보고, kafdrop으로 실제 CDC되는지 관찰해보자

## 2-2. Kafka source connector setting

진행중





# Reference
* [https://www.confluent.io/blog/sync-databases-and-remove-silos-with-kafka-cdc/](https://www.confluent.io/blog/sync-databases-and-remove-silos-with-kafka-cdc/)
* [One way DB sync](https://dbconvert.com/blog/what-is-database-synchronization/)
* [Bi-directional DB sync](https://dbconvert.com/blog/bidirectional-database-synchronization/)
