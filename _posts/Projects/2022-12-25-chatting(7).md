---
title: "실시간 채팅방 구현(7)"
categories:
  - 프로젝트
  - Spring
date: 2022-12-25 09:00:25 +0900
tags:
---
## 진행상황
### Architecture
![img](../../assets/img/kafka/implement.png)
현재 구현된 서비스를 docker compose를 통해 실행시키면 다음과 같이 컨테이너들이 생긴다.
> Kafka와 Chat Server, Auth Server, DB들 모두 외부접속 가능하도록 노출 port를 도커 내부 포트랑 같게 설정했다.
```
gyuminhwangbo@Gyuminui-MacBookPro spring-chatting-server % docker ps
CONTAINER ID   IMAGE                                      COMMAND                  CREATED          STATUS          PORTS                              NAMES
d54365955efa   spring-chatting-server_nginx               "/docker-entrypoint.…"   51 seconds ago   Up 47 seconds   0.0.0.0:8080->80/tcp               nginx
af5c00d411db   spring-chatting-server_chatting-server-2   "java -jar app.jar"      51 seconds ago   Up 48 seconds   0.0.0.0:8084->8084/tcp             chatting-server-2
becb35e0bc1f   spring-chatting-server_chatting-server-1   "java -jar app.jar"      51 seconds ago   Up 48 seconds   0.0.0.0:8083->8083/tcp             chatting-server-1
9bfb2b8d53ca   confluentinc/cp-kafka:7.2.1                "/etc/confluent/dock…"   51 seconds ago   Up 49 seconds   0.0.0.0:8099->8099/tcp, 9092/tcp   kafka3
cc8d6c5944b3   confluentinc/cp-kafka:7.2.1                "/etc/confluent/dock…"   51 seconds ago   Up 49 seconds   0.0.0.0:8097->8097/tcp, 9092/tcp   kafka1
995e41051907   confluentinc/cp-kafka:7.2.1                "/etc/confluent/dock…"   51 seconds ago   Up 49 seconds   0.0.0.0:8098->8098/tcp, 9092/tcp   kafka2
7d355211b1ce   spring-chatting-server_auth-server         "java -jar app.jar"      51 seconds ago   Up 49 seconds   0.0.0.0:8085->8085/tcp             auth-server
29ab743b9847   confluentinc/cp-zookeeper:7.2.1            "/etc/confluent/dock…"   52 seconds ago   Up 50 seconds   2181/tcp, 2888/tcp, 3888/tcp       zookeeper
722bf2b27df5   postgres:12-alpine                         "docker-entrypoint.s…"   52 seconds ago   Up 50 seconds   5432/tcp, 0.0.0.0:5434->5434/tcp   chatting-db-2
ccc3e138004a   postgres:12-alpine                         "docker-entrypoint.s…"   52 seconds ago   Up 50 seconds   5432/tcp, 0.0.0.0:5433->5433/tcp   chatting-db-1
3a52283f6f52   postgres:12-alpine                         "docker-entrypoint.s…"   52 seconds ago   Up 50 seconds   5432/tcp, 0.0.0.0:5435->5435/tcp   auth-db
```
### 구현 완료
* API GATEWAY
  * 채팅서버(/chat)에 접속 시, ip_hash로 특정 서버로만 들어가도록 구현
  * 인증서버(/user)에 접속할 때 uri 맨 뒤 `/`가 붙어야만 접속되었었다. 그래서 `rewrite {regex}`로 맨뒤에 자동으로 `/`를 붙여주도록 설정
* Auth Server
  * 인증서버를 따로 구현함으로써 다른 곳에서도 편하게 이용할 수 있도록 구현
* Chat Server
  * 채팅서버를 수동으로 2대 구축
  > 추후 K8S의 auto-scaling으로 구현할 예정
* Kafka Broker
  * 토픽은 두 개로 올렸으며, 각각 broker 3대 및 2개의 파티션에 걸쳐 백업되도록 운용
  > 파티션은 200개가 적당하다고 한다. 지금 당장은 2개의 파티션으로 운용.

### 구현 미완료
* Front Server
  * API GATEWAY에 비동기+논 블로킹 webClient로 요청 전송 예정
* Log Server
  * DB선정에 있어 고민이 있다. 여러가지 비교해봤을 때, Timescale로 선정하였다. [시계열 데이터에 맞는 DB는?](https://www.reddit.com/r/Database/comments/w8eb0g/best_db_for_logging/)
  > * **Elastic Search**=비쌈.
  > * **HDFS**=낫베드
  > * **File System**=Transaction관리가 어려움.
  > * **Timescale**=기존 Postgres를 시계열로 확장시킨 DB. 그래서 익숙한 SQL문을 그대로 사용할 수 있다는 장점이 있다.
  * 시계열데이터는 다음과 같이 두 가지로 각각의 하이퍼테이블을 구성할 예정
    * symbol = chatAdd, data = 채팅 입력 수
    * symbol = userAdd, data = 신규가입자 수

## 완료된 설정
상세 코드는 [https://github.com/ghkdqhrbals/spring-chatting-server](https://github.com/ghkdqhrbals/spring-chatting-server)에서 확인하능하다.
> main branch에 존재

### 완료된 API GATEWAY(nginx.config)
```
user  nginx;
worker_processes  1;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;
events {
    worker_connections  1024;
}
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    upstream chat-server {
        # IP 해쉬화 하여 특정 서버에 들어가도록 설정
        # https://nginx.org/en/docs/http/ngx_http_upstream_module.html#ip_hash
        ip_hash;
        server chatting-server-1:8083;
        server chatting-server-2:8084;
    }
    upstream auth-server {
        server auth-server:8085;
    }
    server {
        listen 80;
        # 추후 server_name 변경예정
        server_name localhost;

        location / {
            # 채팅서버 backend
            location /chat {
                proxy_pass         http://chat-server;
                proxy_redirect     off;
                proxy_set_header   Host $host;
                proxy_set_header   X-Real-IP $remote_addr; # 클라이언트 요청 ip전송
                proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for; # 클라이언트 요청 ip전송
            }
            # 인증서버 backend
            location /user {
                rewrite ^([^.]*[^/])$ $1/ permanent; # tailing slash with every url
                proxy_pass         http://auth-server;
                proxy_redirect     off;
                proxy_set_header   Host $host;
                proxy_set_header   X-Real-IP $remote_addr;
                proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            }
        }

    }
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    keepalive_timeout  65;
    include /etc/nginx/conf.d/*.conf;
}
```

### 완료된 Docker-compose.yml
```dockerfile
version : '2'
services:
  # -------- API GATEWAY --------
  nginx:
    restart: always
    container_name: nginx
    depends_on:
      - chatting-server-1
      - chatting-server-2
    build:
      context: ./nginx
      dockerfile: Dockerfile
    ports:
      - "8080:80"

  # -------- KAFKA --------
  zookeeper:
    image: confluentinc/cp-zookeeper:7.2.1
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
  kafka1:
    image: confluentinc/cp-kafka:7.2.1
    container_name: kafka1
    ports:
      - "8097:8097"
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: EXTERNAL:PLAINTEXT,INTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: EXTERNAL://localhost:8097,INTERNAL://kafka1:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
  kafka2:
    image: confluentinc/cp-kafka:7.2.1
    container_name: kafka2
    ports:
      - "8098:8098"
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: EXTERNAL:PLAINTEXT,INTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: EXTERNAL://localhost:8098,INTERNAL://kafka2:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
  kafka3:
    image: confluentinc/cp-kafka:7.2.1
    container_name: kafka3
    ports:
      - "8099:8099"
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: EXTERNAL://localhost:8099,INTERNAL://kafka3:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: EXTERNAL:PLAINTEXT,INTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL

  # -------- Chatting Server --------
  chatting-db-1:
    container_name: chatting-db-1
    image: postgres:12-alpine
    environment:
      - POSTGRES_PASSWORD=password
      - POSTGRES_USER=postgres
      - POSTGRES_DB=chat
    expose:
      - "5433" # Publishes 5433 to other containers but NOT to host machine
    ports:
      - "5433:5433"
    volumes:
      - ./backups:/home/backups
    command: -p 5433
  chatting-server-1:
    container_name: chatting-server-1
    build: ./spring-chatting-backend-server
    ports:
      - "8083:8083"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://chatting-db-1:5433/chat
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=password
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SERVER_PORT=8083
      - KAFKA_BOOTSTRAP=kafka1:9092,kafka2:9092,kafka3:9092 # 내부포트
    depends_on:
      - kafka1
      - kafka2
      - kafka3
      - chatting-db-1
    restart: always
  chatting-db-2:
    container_name: chatting-db-2
    image: postgres:12-alpine
    environment:
      - POSTGRES_PASSWORD=password
      - POSTGRES_USER=postgres
      - POSTGRES_DB=chat
    expose:
      - "5434" # Publishes 5433 to other containers but NOT to host machine
    ports:
      - "5434:5434"
    volumes:
      - ./backups:/home/backups
    command: -p 5434
  chatting-server-2:
    container_name: chatting-server-2
    build: ./spring-chatting-backend-server
    ports:
      - "8084:8084"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://chatting-db-2:5434/chat
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=password
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SERVER_PORT=8084
      - KAFKA_BOOTSTRAP=kafka1:9092,kafka2:9092,kafka3:9092 # 내부포트
    depends_on:
      - kafka1
      - kafka2
      - kafka3
      - chatting-db-2
    restart: always

  # -------- Authentication Server --------
  auth-db:
    container_name: auth-db
    image: postgres:12-alpine
    environment:
      - POSTGRES_PASSWORD=password
      - POSTGRES_USER=postgres
      - POSTGRES_DB=auth
    expose:
      - "5435" # Publishes 5433 to other containers but NOT to host machine
    ports:
      - "5435:5435"
    volumes:
      - ./backups:/home/backups
    command: -p 5435
  auth-server:
    container_name: auth-server
    build: ./spring-auth-backend-server
    ports:
      - "8085:8085"
    environment:
      - SERVER_PORT=8085
      - SPRING_DATASOURCE_URL=jdbc:postgresql://auth-db:5435/auth
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=password
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
    depends_on:
      - auth-db
    restart: always
```

