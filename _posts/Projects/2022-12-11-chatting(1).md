---
title: "실시간 채팅방 구현(1)"
categories:
  - 프로젝트
  - Spring
date: 2022-12-11 15:00:25 +0900
tags:
---
현재까지 **version1 실시간 채팅방 구현을 위한 Kafka/STOMP/Spring 연동이 완료**되었다. 상세한 내용과 코드는 다음의 github 링크에서 확인할 수 있다.

GITHUB : [https://github.com/ghkdqhrbals/spring-chatting-server/tree/v1](https://github.com/ghkdqhrbals/spring-chatting-server/tree/v1)

v1 동작 : [https://www.youtube.com/watch?v=nwD3AX6CJcc](https://www.youtube.com/watch?v=nwD3AX6CJcc)

**하지만 아직 Kafka가 제대로 활용되지 않았고 다른 기능들도 미비하여 추가하려한다.**

## 현재의 프로젝트에 Kafka를 연동함으로써 예상되는 장점
* Kafka Connect의 CDC로 백업 DB Sync 설정가능
> Kafka Connect : 트랜젝션 log CDC(Change Data Capture)로 sync.
* 이전에는 WebSocket으로 Direct하게 메세지를 전송하였다면, Kafka Consumer에서 이를 처리함으로써 메세지 전송 실패시 재전송 가능
* 서버(:8080 포트) 다운 시, kafka의 zooKeeper에서 변화감지 및 Consumer 변경 가능함으로써 서버다운대처가능
* chatting I/O 기다리지 않아도 됨(이는 이미 pub/sub방식 stomp로 처리하면서 해결됨)


## 추가할 작업
* Chatting 메세지를 저장하는 Repository 추가
> 고려할 점
> 1. 사용자가 **마지막에 읽은 채팅의 위치를 저장하는 칼럼 추가**
> 2. 지금 채팅방에 입장할때마다 입장메세지가 표시된다. 이것을 삭제하고 입장메세지의 토픽인 /pub/chat/enter의 핸들러를 거칠때마다 **마지막 읽은 메세지의 위치 표시(반환)**
> 3. 카카오의 `톡서랍`처럼 나한테 중요한 메세지들을 채팅방,채팅메세지,시간 이렇게 저장할 수 있도록 **중요메세지 저장 테이블 추가**
* Room/Participant 제거기능 추가
* User가 삭제되었을 때, 연관된 데이터 삭제하도록 데이터 흐름 관찰(JPA실제 쿼리문 관찰)
* Kafka 추가설정
> 고려할 점
> * 현재 Consumer은 하나이며, **logging하는 서버를 추가**로 Consumer로 지정하려한다
> * Partition + Broker 추가
> * Docker-compose로 Kafka/DB/Spring 구동 편리성 도모
> * Spring 서버 다운 시, 대책마련
> * 메시지가 소비될 떄, 멱등성 고려해야함
> * ElasticSearch LoggingServer 추가

아래는 정말 도움 많이 받은 질문
* [https://softwareengineering.stackexchange.com/questions/422177/is-kafka-needed-in-a-realtime-chat-application](https://softwareengineering.stackexchange.com/questions/422177/is-kafka-needed-in-a-realtime-chat-application)

# Reference
1. [https://softwareengineering.stackexchange.com/questions/422177/is-kafka-needed-in-a-realtime-chat-application](https://softwareengineering.stackexchange.com/questions/422177/is-kafka-needed-in-a-realtime-chat-application)
2. [https://www.confluent.io/blog/sync-databases-and-remove-silos-with-kafka-cdc/](https://www.confluent.io/blog/sync-databases-and-remove-silos-with-kafka-cdc/)
