<!DOCTYPE html><html lang="ko-KR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Database-Transaction 격리수준" /><meta property="og:locale" content="ko_KR" /><meta name="description" content="모든 데이터베이스는 아래의 트랜젝션 격리 수준을 가진다. READ UNCOMMITTED READ COMMITTED REPEATABLE READ SERIALIZABLE" /><meta property="og:description" content="모든 데이터베이스는 아래의 트랜젝션 격리 수준을 가진다. READ UNCOMMITTED READ COMMITTED REPEATABLE READ SERIALIZABLE" /><link rel="canonical" href="/posts/DB-2/" /><meta property="og:url" content="/posts/DB-2/" /><meta property="og:site_name" content="Austin" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-11-20T06:00:25+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Database-Transaction 격리수준" /><meta name="twitter:site" content="@ghkdqhrbals" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-12-02T10:49:53+00:00","datePublished":"2022-11-20T06:00:25+00:00","description":"모든 데이터베이스는 아래의 트랜젝션 격리 수준을 가진다. READ UNCOMMITTED READ COMMITTED REPEATABLE READ SERIALIZABLE","headline":"Database-Transaction 격리수준","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/DB-2/"},"url":"/posts/DB-2/"}</script><title>Database-Transaction 격리수준 | Austin</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Austin"><meta name="application-name" content="Austin"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/avatar/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Austin</a></div><div class="site-subtitle font-italic"> Record every seconds</div><div class="site-subtitle"> <a href="https://ghkdqhrbals.github.io/portfolios/" class="mx-auto" style="color: #ffd700"> See my portfolio </a></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>홈</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>카테고리</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>태그</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>아카이브</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>정보</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/ghkdqhrbals" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ghkdqhrbals','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> 홈 </a> </span> <span>Database-Transaction 격리수준</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 포스트</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="검색..."> </span> <span id="search-cancel" >취소</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4 pb-5"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Database-Transaction 격리수준</h1><div class="post-meta text-muted"> <span> 게시 <em class="" data-ts="1668924025" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-11-20 </em> </span> <span> 업데이트 <em class="" data-ts="1669978193" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-12-02 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/ghkdqhrbals">ghkdqhrbals</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1858 단어"> <em>10 분</em>읽는 시간</span></div></div></div><div class="post-content"><p>모든 데이터베이스는 아래의 트랜젝션 격리 수준을 가진다.</p><ol><li>READ UNCOMMITTED<li>READ COMMITTED<li>REPEATABLE READ<li>SERIALIZABLE</ol><blockquote><p>이해를 돕기 위해 A,B 트랜젝션이 동시에 특정 데이터에 진입할 때를 가정한다.</p></blockquote><h2 id="1-read-uncommitted"><span class="mr-2">1. READ UNCOMMITTED</span><a href="#1-read-uncommitted" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h4 id="트랜젝션간-아무런-격리가-되지-않는-격리레벨이다"><span class="mr-2">트랜젝션간 아무런 격리가 되지 않는 격리레벨이다.</span><a href="#트랜젝션간-아무런-격리가-되지-않는-격리레벨이다" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>A에서 데이터를 1에서 2로 변경했을 때, B가 이를 읽으면 변경된 값인 2로 읽는 것이 본 격리 수준이다.</p><p>즉 데이터를 변경하는 즉시 다른 트랜잭션이 읽으면, <strong>변경되고 난 이후 값</strong>을 읽는다.</p><blockquote class="prompt-warning"><div><p><strong>발생할 수 있는 문제점 : Dirty Read</strong></p><p><strong>Dirty Read</strong> : A가 값 변경하고 B가 읽었을 때, A가 롤백을 할 경우에 발생한다. 이 때, B는 이미 없는 값으로 로직을 수행하게 되버린다.</p></div></blockquote><h2 id="2-read-committed"><span class="mr-2">2. READ COMMITTED</span><a href="#2-read-committed" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h4 id="백업-레코드로-dirty-read를-방지하는-격리레벨이다"><span class="mr-2"><code class="language-plaintext highlighter-rouge">백업 레코드</code>로 Dirty Read를 방지하는 격리레벨이다.</span><a href="#백업-레코드로-dirty-read를-방지하는-격리레벨이다" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>어떤 트랜잭션의 변경 내용이 COMMIT 되어야만 다른 트랜잭션에서 조회할 수 있다.</p><p>다른 트랜잭션에서의 <strong>변경 사항이 커밋되지 않은 경우, 실제 테이블의 값이 아닌 백업된 레코드</strong>에서 값을 가져오게 된다.</p><p>하지만 <strong>NON-REPEATABLE READ</strong> 문제점 발생.</p><blockquote class="prompt-warning"><div><p><strong>발생할 수 있는 문제점 : NON-REPEATABLE READ</strong></p><p><strong>NON-REPEATABLE READ</strong> : 트랜젝션 내, 같은 SELECT 쿼리를 두번 수행할 떄 매번 결과가 달라지는 문제점(중간에 다른 트랜젝션에서 update 커밋했을 떄 발생함)</p><ul><li><strong>1번과 4번의 쿼리결과가 일치하지 않는다</strong></ul><div class="table-wrapper"><table><thead><tr><th>번호<th>Tx1<th>Tx2<tbody><tr><td>1<td>SELECT * FROM MEMBER<td> <tr><td>2<td> <td>UPDATE MEMBER SET a = ‘c’ WHERE a = ‘a’<tr><td>3<td> <td>COMMIT<tr><td>4<td>SELECT * FROM MEMBER<td> </table></div><ul><li>실험(<strong>postgresql</strong>)</ul><p>실험 주의점 : 두 개의 터미널에서 psql을 실행하여 각각의 트랜젝션을 실행해야한다. psql은 기본적으로 sql을 실행할 떄, BEGIN/COMMIT을 뒤에 넣어 싱글 트랜젝션으로 실행하기 떄문이다.</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">START</span> <span class="n">TRANSACTION</span><span class="p">;</span> <span class="c1">-- transaction id : 1</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">MEMBER</span><span class="p">;</span>
   <span class="k">START</span> <span class="n">TRANSACTION</span><span class="p">;</span> <span class="c1">-- transaction id : 2</span>
   <span class="k">UPDATE</span> <span class="n">MEMBER</span> <span class="k">SET</span> <span class="n">a</span> <span class="o">=</span> <span class="s1">'c'</span> <span class="k">WHERE</span> <span class="n">a</span> <span class="o">=</span> <span class="s1">'a'</span><span class="p">;</span>
   <span class="k">COMMIT</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">MEMBER</span><span class="p">;</span>
<span class="k">COMMIT</span><span class="p">;</span>
</pre></table></code></div></div><p>1번 쿼리 결과 : a,b 4번 쿼리 결과 : b,c</p></div></blockquote><h2 id="3-repeatable-read"><span class="mr-2">3. REPEATABLE READ</span><a href="#3-repeatable-read" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h4 id="백업-레코드중간커밋-제외로-트랜젝션을-제어하는-격리레벨이다"><span class="mr-2"><code class="language-plaintext highlighter-rouge">백업 레코드</code>+<code class="language-plaintext highlighter-rouge">중간커밋 제외</code>로 트랜젝션을 제어하는 격리레벨이다.</span><a href="#백업-레코드중간커밋-제외로-트랜젝션을-제어하는-격리레벨이다" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>트랜잭션이 시작되기 전에 커밋된 내용에 대해서만 조회</strong>할 수 있는 격리수준. 그래서 같은 쿼리를 날려도 일관된 결과를 보장한다. 문제는 insert로 인해 유령 레코드가 나타나는 <strong>PHANTOM READ</strong> 문제점이 존재한다(postgres는 이 격리에서 PHANTOM READ 발생 X).</p><p>postgresql은 이 격리로 트랜젝션을 진행하면 <strong>테이블 자체를 백업</strong>으로 가져온다. 그래서 PHANTOM READ같은 문제점이 발생하지 않는다.</p><p>즉, DB마다 성향과 에러 핸들링이 다르기때문에 모두 테스트 해봐야한다.</p><blockquote class="prompt-warning"><div><p><strong>발생할 수 있는 문제점 : PHANTOM READ</strong></p><p><strong>PHANTOM READ</strong> : 다른 트랜잭션에서 수행한 insert 작업에 의해 레코드가 보였다가 안보였다가 하는 현상</p><ul><li>실험(<strong>MARIA DB</strong>)</ul><p><strong>1번과 5번의 쿼리결과가 일치하지 않는다</strong></p><div class="table-wrapper"><table><thead><tr><th>번호<th>Tx1<th>Tx2<tbody><tr><td>1<td>select count(*) from Coupon<td> <tr><td>2<td> <td><strong>insert</strong> into Coupon values (‘c’)<tr><td>3<td> <td>COMMIT<tr><td>4<td>update Coupon set name = ‘d’<td> <tr><td>5<td>select count(*) from Coupon<td> </table></div></div></blockquote><blockquote><p>하지만 위와 같은 결과는 postgresql에서는 일어나지 않는다.</p></blockquote><h2 id="4-serializable"><span class="mr-2">4. SERIALIZABLE</span><a href="#4-serializable" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h4 id="어떤-트랜잭션이-접근-하는-테이블-자체의-모든-rw에-lock을-건다-그래서-완벽한-일관성-보장"><span class="mr-2">어떤 트랜잭션이 접근 하는 테이블 자체의 모든 R/W에 Lock을 건다. 그래서 완벽한 일관성 보장.</span><a href="#어떤-트랜잭션이-접근-하는-테이블-자체의-모든-rw에-lock을-건다-그래서-완벽한-일관성-보장" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p>The transaction waits until rows write-locked by other transactions are unlocked; this prevents it from reading any “dirty” data.</p><p>The transaction holds a read lock (if it only reads rows) or write lock (if it can update or delete rows) on the range of rows it affects. For example, if the transaction includes the SQL statement SELECT * FROM Orders, the range is the entire Orders table; the transaction read-locks the table and does not allow any new rows to be inserted into it. If the transaction includes the SQL statement DELETE FROM Orders WHERE Status = ‘CLOSED’, the range is all rows with a Status of “CLOSED”; the transaction write-locks all rows in the Orders table with a Status of “CLOSED” and does not allow any rows to be inserted or updated such that the resulting row has a Status of “CLOSED”.</p><p>Because other transactions cannot update or delete the rows in the range, the current transaction avoids any nonrepeatable reads. Because other transactions cannot insert any rows in the range, the current transaction avoids any phantoms. The transaction releases its lock when it is committed or rolled back.</p><p>Reference in <a href="https://learn.microsoft.com/en-us/sql/odbc/reference/develop-app/transaction-isolation-levels?view=sql-server-ver16">https://learn.microsoft.com/en-us/sql/odbc/reference/develop-app/transaction-isolation-levels?view=sql-server-ver16</a></p></blockquote><h2 id="jpa-데이터-lock"><span class="mr-2">JPA 데이터 Lock</span><a href="#jpa-데이터-lock" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="비관적-잠금pessimistic-lock"><span class="mr-2">비관적 잠금(Pessimistic Lock)</span><a href="#비관적-잠금pessimistic-lock" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="현재-내가-readwrite하고-있는-데이터에-lock을-거는-기능"><span class="mr-2">현재 내가 Read/Write하고 있는 데이터에 Lock을 거는 기능</span><a href="#현재-내가-readwrite하고-있는-데이터에-lock을-거는-기능" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>READ COMMIT을 기본격리로 제공하는 데이터베이스의 경우 백업 레코드 접근을 허용한다. 데이터베이스에 쿼리가 날라가기 전 JPA에서 비관적 잠금으로 설정하게 된다면, 백업레코드 접근이 아닌 실제 레코드에 접근한다.</p><blockquote><p>h2-database/Postgres 는 기본적으로 READ COMMIT 트랜젝션 격리단계를 가진다. 따라서 쿠폰 발급 서비스에 동시에 사용자 요청이 들어왔을 때, 같은 데이터를 들고 수정할 수 있게 되버린다.</p></blockquote><p>JPA는 비관적 잠금을 용도에 따라 두 가지로 제공한다.</p><ol><li>읽기 잠금(Pessimistic Read Lock)<li>쓰기 잠금(Pessimistic Write Lock)</ol><h4 id="1-비관적-읽기-잠금pessimistic-read-lock"><span class="mr-2">1. 비관적 읽기 잠금(Pessimistic Read Lock)</span><a href="#1-비관적-읽기-잠금pessimistic-read-lock" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>트랜젝션이 <strong>특정 데이터를 UPDATE로 변경할 때만 잠금</strong>한다. 해당 잠금은 READ COMMIT 에서는 기본적으로 제공하기에 실제로는 사용될 일이 거의 없다.</p><p>일기 잠금은 만약 SELECT로 읽는다면 Lock하지 않는다. 따라서 다른 트랜젝션도 이를 읽을 수 있다.</p><h4 id="2-비관적-쓰기-잠금pessimistic-write-lock"><span class="mr-2">2. 비관적 쓰기 잠금(Pessimistic Write Lock)</span><a href="#2-비관적-쓰기-잠금pessimistic-write-lock" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>쿼리가 나갈 때, 뒤에 <code class="language-plaintext highlighter-rouge">FOR UPDATE</code>를 붙여주는 기능이다. 즉, 읽기에도 Lock을 걸어주는 기능.</p><p>이 잠금은 데이터 정합성을 잘 지킬 수 있지만, <strong>DeadLock</strong>과 <strong>성능이슈</strong>를 조심해야한다.</p><ul><li>Dead Lock : 트랜젝션들이 서로 Lock되어있는 로우를 무한히 참조하려하는 문제점이다.<li>성능 이슈 : 간단히 읽을 때도 Lock이 걸리기 때문에 <strong>동시사용자가 많은 경우</strong>, 사용자들은 오랜시간 기다리게 된다.</ul><p>오라클은 waiting time도 설정할 수 있어 쉽게 핸들링가능.</p><blockquote><p>물론 트랜젝션이 끝나기 전, 다시 한번더 읽어서 데이터 정합성을 유지하는 방법도 존재한다.</p><p>하지만 동시 사용자 수가 월등히 많을 때 이 역시 깨질 수 있기에, 이후 확장성을 고려한다면 비관적 쓰기 잠금을 고려할만하다.</p></blockquote><p>Spring Data JPA에서는 아래와 같이 비관적 쓰기 잠금을 선언할 수 있다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CouponRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Coupon</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Lock</span><span class="o">(</span><span class="nc">LockModeType</span><span class="o">.</span><span class="na">PESSIMISTIC_WRITE</span><span class="o">)</span> <span class="c1">// Pessimistic Lock 설정(베타적 Lock)</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">"select c from Coupon c where c.couponItem.couponCode = :couponCode and c.userId is NULL"</span><span class="o">)</span>
    <span class="nd">@QueryHints</span><span class="o">({</span><span class="nd">@QueryHint</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"javax.persistence.lock.timeout"</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span><span class="s">"3000"</span><span class="o">)})</span> <span class="c1">// 3초 타임아웃(set waiting time)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Coupon</span><span class="o">&gt;</span> <span class="nf">findByCouponCode</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"couponCode"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">couponCode</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span> <span class="c1">// Pageable = limit</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/cs/'>CS</a>, <a href='/categories/%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4/'>데이터베이스</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 이 기사는 저작권자의 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 라이센스를 따릅니다.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">공유하기</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Database-Transaction+%EA%B2%A9%EB%A6%AC%EC%88%98%EC%A4%80+-+Austin&url=%2Fposts%2FDB-2%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Database-Transaction+%EA%B2%A9%EB%A6%AC%EC%88%98%EC%A4%80+-+Austin&u=%2Fposts%2FDB-2%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2FDB-2%2F&text=Database-Transaction+%EA%B2%A9%EB%A6%AC%EC%88%98%EC%A4%80+-+Austin" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="링크 복사하기" data-title-succeed="링크가 복사되었습니다!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">인기 태그</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cs-information/">CS information</a> <a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/backend/">backend</a> <a class="post-tag" href="/tags/error/">error</a> <a class="post-tag" href="/tags/ethereum/">Ethereum</a> <a class="post-tag" href="/tags/msa/">msa</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/restful/">RESTFUL</a> <a class="post-tag" href="/tags/token/">token</a> <a class="post-tag" href="/tags/database/">database</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">바로가기</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>관련된 글</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/DB-transcation/"><div class="card-body"> <em class="small" data-ts="1644300025" data-df="YYYY-MM-DD" > 2022-02-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Database-Transaction</h3><div class="text-muted small"><p> What is Database Transaction? It refers to the unit of work performed by changing the state of the database. Simply put, it means accessing the database using the following query(SELECT, UPDAT...</p></div></div></a></div><div class="card"> <a href="/posts/DB-1/"><div class="card-body"> <em class="small" data-ts="1665036025" data-df="YYYY-MM-DD" > 2022-10-06 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Database-Normalization</h3><div class="text-muted small"><p> What is schema? DB schema : a metadata that how data is organized within a relational database this is inclusive of logical constraints such as, table names, fields, data types, and t...</p></div></div></a></div><div class="card"> <a href="/posts/network(1)/"><div class="card-body"> <em class="small" data-ts="1640757625" data-df="YYYY-MM-DD" > 2021-12-29 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Network-1:OSI 7 Layers</h3><div class="text-muted small"><p> What is difference between OSI 7 Layers and TCP/IP 4 Layers? There are 7 layers of OSI and 4 layers of TCP/IP which suppport every protocol of computer. The difference is that how they divide the ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98/" class="btn btn-outline-primary" prompt="이전 글"><p>등산코스 정하기</p></a> <a href="/posts/message-queue/" class="btn btn-outline-primary" prompt="다음 글"><p>메세지 큐(MQ)의 개념 및 장점</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">인기 태그</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cs-information/">CS information</a> <a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/backend/">backend</a> <a class="post-tag" href="/tags/error/">error</a> <a class="post-tag" href="/tags/ethereum/">Ethereum</a> <a class="post-tag" href="/tags/msa/">msa</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/restful/">RESTFUL</a> <a class="post-tag" href="/tags/token/">token</a> <a class="post-tag" href="/tags/database/">database</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/ghkdqhrbals">ghkdqhrbals</a>. <span data-toggle="tooltip" data-placement="top" title="명시되지 않는 한 이 사이트의 블로그 게시물은 작성자의 Creative Commons Attribution 4.0 International(CC BY 4.0) 라이선스에 따라 사용이 허가되었습니다.">일부 권리 보유</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">새 버전의 콘텐츠를 사용할 수 있습니다.</p><button type="button" class="btn btn-primary" aria-label="Update"> 업데이트 </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">검색 결과가 없습니다.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-VTR1DF5BPL"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-VTR1DF5BPL'); }); </script>
