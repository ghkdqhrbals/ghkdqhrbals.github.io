<!DOCTYPE html><html lang="ko-KR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="실시간 채팅방 구현(12) - (대량 Rest api test 한계 돌파)" /><meta property="og:locale" content="ko_KR" /><meta name="description" content="INDEX 랜덤값으로 test하는 code 10000개 rest api 트래픽 실행(110초 소요)" /><meta property="og:description" content="INDEX 랜덤값으로 test하는 code 10000개 rest api 트래픽 실행(110초 소요)" /><link rel="canonical" href="/posts/chatting(12)/" /><meta property="og:url" content="/posts/chatting(12)/" /><meta property="og:site_name" content="Austin" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-01-15T00:00:25+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="실시간 채팅방 구현(12) - (대량 Rest api test 한계 돌파)" /><meta name="twitter:site" content="@ghkdqhrbals" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-01-29T08:19:41+00:00","datePublished":"2023-01-15T00:00:25+00:00","description":"INDEX 랜덤값으로 test하는 code 10000개 rest api 트래픽 실행(110초 소요)","headline":"실시간 채팅방 구현(12) - (대량 Rest api test 한계 돌파)","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/chatting(12)/"},"url":"/posts/chatting(12)/"}</script><title>실시간 채팅방 구현(12) - (대량 Rest api test 한계 돌파) | Austin</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Austin"><meta name="application-name" content="Austin"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/avatar/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Austin</a></div><div class="site-subtitle font-italic"> Record every seconds</div><div class="site-subtitle"> <a href="https://ghkdqhrbals.github.io/portfolios/" class="mx-auto" style="color: #ffd700"> See my portfolio </a></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>홈</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>카테고리</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>태그</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>아카이브</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>정보</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/ghkdqhrbals" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ghkdqhrbals','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> 홈 </a> </span> <span>실시간 채팅방 구현(12) - (대량 Rest api test 한계 돌파)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 포스트</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="검색..."> </span> <span id="search-cancel" >취소</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4 pb-5"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>실시간 채팅방 구현(12) - (대량 Rest api test 한계 돌파)</h1><div class="post-meta text-muted"> <span> 게시 <em class="" data-ts="1673740825" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2023-01-15 </em> </span> <span> 업데이트 <em class="" data-ts="1674980381" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2023-01-29 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/ghkdqhrbals">ghkdqhrbals</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1369 단어"> <em>7 분</em>읽는 시간</span></div></div></div><div class="post-content"><h1 id="index">INDEX</h1><ul><li>랜덤값으로 test하는 code<li>10000개 rest api 트래픽 실행(110초 소요)</ul><p>이제 동시 연결가능한 TCP 소켓을 필자의 맥북이 버틸 수 있는만큼 열어서 다량의 http request를 서버로 전송해볼려고 한다.</p><div class="language-golang highlighter-rouge"><div class="code-header"> <span data-label-text="Golang"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>	<span class="n">t</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">DefaultTransport</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Transport</span><span class="p">)</span><span class="o">.</span><span class="n">Clone</span><span class="p">()</span>
	<span class="n">t</span><span class="o">.</span><span class="n">MaxIdleConns</span> <span class="o">=</span> <span class="m">10000</span>
	<span class="n">t</span><span class="o">.</span><span class="n">MaxConnsPerHost</span> <span class="o">=</span> <span class="m">10000</span>
	<span class="n">t</span><span class="o">.</span><span class="n">MaxIdleConnsPerHost</span> <span class="o">=</span> <span class="m">1</span>

	<span class="c">// 클라이언트 설정 및 timeout</span>
	<span class="n">client</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">http</span><span class="o">.</span><span class="n">Client</span><span class="p">{</span>
		<span class="n">Timeout</span><span class="o">:</span>   <span class="m">1</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
		<span class="n">Transport</span><span class="o">:</span> <span class="n">t</span><span class="p">,</span>
	<span class="p">}</span>
</pre></table></code></div></div><p>Transport 설정을 잠깐 설명하자면 아래와 같다.</p><ol><li>MaxIdleConns : 전체 커넥션 풀<li>MaxConnsPerHost : 호스트 별(서버) 할당 가능한 커넥션 개수<li><strong>MaxIdleConnsPerHost</strong> : 호스트 별 활성화 되지 않아도 유지하는 최대 connection 개수.(Server-Sent Event같이 클라이언트가 따로 뭘 안보내도 서버가 계속 보내야 될 때 필요하다. 본 테스트에서는 필요업으니 pass)<li>Dial.Timeout = tcp 소켓 유지 타임아웃(Keep-alive 시간) - http.Client.Timeout랑 같다.<li>http.Client.Timeout : 클라이언트(테스트 클라이언트)가 송신/수신이 끝나면 connection 유지하는 시간</ol><p>현재 필자의 맥북은 약 tcp 소켓을 동시에 10K까지는 무난히 열 수 있다. 따라서 10K로 커넥션 풀을 설정한다. 또한 status code 200을 수신받기 위한 수정된 코드를 실행하며 스레드는 100개로 실행한다.</p><h2 id="랜덤값으로-test하는-code"><span class="mr-2">랜덤값으로 test하는 code</span><a href="#랜덤값으로-test하는-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-golang highlighter-rouge"><div class="code-header"> <span data-label-text="Golang"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
</pre><td class="rouge-code"><pre><span class="o">...</span>
<span class="k">type</span> <span class="n">User</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">UserId</span>   <span class="kt">string</span> <span class="s">`json:"userId"`</span>
	<span class="n">UserName</span> <span class="kt">string</span> <span class="s">`json:"userName"`</span>
	<span class="n">Email</span>    <span class="kt">string</span> <span class="s">`json:"email"`</span>
	<span class="n">UserPw</span>   <span class="kt">string</span> <span class="s">`json:"userPw"`</span>
<span class="p">}</span>
<span class="k">type</span> <span class="n">Usera</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Name</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">rand</span><span class="o">.</span><span class="n">Seed</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">UnixNano</span><span class="p">())</span>
<span class="p">}</span>

<span class="k">var</span> <span class="n">letterRunes</span> <span class="o">=</span> <span class="p">[]</span><span class="kt">rune</span><span class="p">(</span><span class="s">"김이박최정강조윤장임한오서신권황안송류전홍고문양손배조백허유남심노정하곽성차주우구신임나전민유진지엄채원천방공강현함변염양변여추노도소신석선설마길주연방위표명기반왕금옥육인맹제모장남탁국여진어은편구용"</span><span class="p">)</span>
<span class="k">var</span> <span class="n">letterRunes_name</span> <span class="o">=</span> <span class="p">[]</span><span class="kt">rune</span><span class="p">(</span><span class="s">"가강건경고관광구규근기길나남노누다단달담대덕도동두라래로루리마만명무문미민바박백범별병보빛사산상새서석선설섭성세소솔수숙순숭슬승시신아안애엄여연영예오옥완요용우원월위유윤율으은의이익인일잎자잔장재전정제조종주준중지진찬창채천철초춘충치탐태택판하한해혁현형혜호홍화환회효훈휘희운모배부림봉혼황량린을비솜공면탁온디항후려균묵송욱휴언령섬들견추걸삼열웅분변양출타흥겸곤번식란더손술훔반빈실직흠흔악람뜸권복심헌엽학개롱평늘늬랑얀향울련"</span><span class="p">)</span>

<span class="k">const</span> <span class="n">letterBytes_id</span> <span class="o">=</span> <span class="s">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>

<span class="k">func</span> <span class="n">RandStringBytes</span><span class="p">(</span><span class="n">n</span> <span class="kt">int</span><span class="p">,</span> <span class="n">letterBytes</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="n">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">b</span> <span class="p">{</span>
		<span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">letterBytes</span><span class="p">[</span><span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">letterBytes</span><span class="p">))]</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kt">string</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">RandStringRunes_firstname</span><span class="p">(</span><span class="n">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="n">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">rune</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">b</span> <span class="p">{</span>
		<span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">letterRunes</span><span class="p">[</span><span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">letterRunes</span><span class="p">))]</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kt">string</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">RandStringRunes_lastname</span><span class="p">(</span><span class="n">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="n">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">rune</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">b</span> <span class="p">{</span>
		<span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">letterRunes_name</span><span class="p">[</span><span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">letterRunes_name</span><span class="p">))]</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kt">string</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">worker</span><span class="p">(</span><span class="n">contexts</span> <span class="o">*</span><span class="n">sync</span><span class="o">.</span><span class="n">Map</span><span class="p">,</span> <span class="n">wg</span> <span class="o">*</span><span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span><span class="p">,</span> <span class="n">requestURL</span> <span class="kt">string</span><span class="p">,</span> <span class="n">jsonBody</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="n">client</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Client</span><span class="p">,</span> <span class="n">transferRatePerSecond</span> <span class="kt">int</span><span class="p">,</span> <span class="n">number_worker</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Threads start:"</span><span class="p">,</span> <span class="n">number_worker</span><span class="p">)</span>
	<span class="c">// 로컬 맵 생성</span>
	<span class="n">m</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">transferRatePerSecond</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">User</span><span class="p">{</span>
			<span class="n">UserId</span><span class="o">:</span>   <span class="n">RandStringBytes</span><span class="p">(</span><span class="m">8</span><span class="p">,</span> <span class="n">letterBytes_id</span><span class="p">),</span>
			<span class="n">UserName</span><span class="o">:</span> <span class="n">RandStringRunes_lastname</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">RandStringRunes_firstname</span><span class="p">(</span><span class="m">2</span><span class="p">),</span>
			<span class="n">Email</span><span class="o">:</span>    <span class="n">RandStringBytes</span><span class="p">(</span><span class="m">5</span><span class="p">,</span> <span class="n">letterBytes_id</span><span class="p">)</span> <span class="o">+</span> <span class="s">"@gmail.com"</span><span class="p">,</span>
			<span class="n">UserPw</span><span class="o">:</span>   <span class="n">RandStringBytes</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="n">letterBytes_id</span><span class="p">),</span>
		<span class="p">}</span>
		<span class="n">buf</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Marshal</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="n">bodyReader</span> <span class="o">:=</span> <span class="n">bytes</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="c">// 요청 생성</span>
		<span class="n">req</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">NewRequest</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">MethodPost</span><span class="p">,</span> <span class="n">requestURL</span><span class="p">,</span> <span class="n">bodyReader</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
		<span class="p">}</span>

		<span class="c">// json 헤더 설정</span>
		<span class="n">req</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span> <span class="s">"application/json"</span><span class="p">)</span>

		<span class="c">// 실제 요청 전송 및 반환</span>
		<span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

		<span class="c">// 로컬 맵에 삽입</span>
		<span class="n">m</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">StatusCode</span><span class="p">]</span> <span class="o">+=</span> <span class="m">1</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">m</span> <span class="p">{</span>
		<span class="n">result</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">contexts</span><span class="o">.</span><span class="n">Load</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">ok</span> <span class="p">{</span>
			<span class="n">contexts</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">+</span><span class="n">v</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">contexts</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

	<span class="n">argsWithoutProg</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]</span>
	<span class="k">var</span> <span class="n">wg</span> <span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span>

	<span class="n">number_worker</span> <span class="o">:=</span> <span class="m">100</span>
	<span class="c">// http 전송 url</span>
	<span class="n">requestURL</span> <span class="o">:=</span> <span class="n">argsWithoutProg</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>

	<span class="c">// json 파일 경로 ex) user</span>
	<span class="c">// .json 확장자 명은 제외</span>
	<span class="n">jsonReq</span> <span class="o">:=</span> <span class="n">argsWithoutProg</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>

	<span class="c">// 실행횟수 설정</span>
	<span class="n">transferRatePerSecond</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">argsWithoutProg</span><span class="p">[</span><span class="m">2</span><span class="p">])</span>

	<span class="c">// JSON 파일 읽기</span>
	<span class="n">jsonFile</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">jsonReq</span> <span class="o">+</span> <span class="s">".json"</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="n">jsonFile</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

	<span class="n">t</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">DefaultTransport</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Transport</span><span class="p">)</span><span class="o">.</span><span class="n">Clone</span><span class="p">()</span>
	<span class="n">t</span><span class="o">.</span><span class="n">MaxIdleConns</span> <span class="o">=</span> <span class="m">10000</span>    <span class="c">// connection pool 크기</span>
	<span class="n">t</span><span class="o">.</span><span class="n">MaxConnsPerHost</span> <span class="o">=</span> <span class="m">10000</span> <span class="c">// 호스트 별 최대 할당 connection</span>
	<span class="n">t</span><span class="o">.</span><span class="n">MaxIdleConnsPerHost</span> <span class="o">=</span> <span class="m">1</span>

	<span class="c">// 클라이언트 설정 및 timeout</span>
	<span class="n">client</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">http</span><span class="o">.</span><span class="n">Client</span><span class="p">{</span>
		<span class="n">Timeout</span><span class="o">:</span>   <span class="m">5</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
		<span class="n">Transport</span><span class="o">:</span> <span class="n">t</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="c">// json파일을 바이트로 변환</span>
	<span class="n">jsonBody</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">jsonFile</span><span class="p">)</span>

	<span class="c">// 스레드 싱크 맵</span>
	<span class="k">var</span> <span class="n">contexts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sync</span><span class="o">.</span><span class="n">Map</span><span class="p">{}</span>

	<span class="c">// 멀티 스레드 http request</span>
	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">number_worker</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="n">wg</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
		<span class="k">go</span> <span class="n">worker</span><span class="p">(</span><span class="n">contexts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wg</span><span class="p">,</span> <span class="n">requestURL</span><span class="p">,</span> <span class="n">jsonBody</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">transferRatePerSecond</span><span class="o">/</span><span class="n">number_worker</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">wg</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>

	<span class="c">// 성공한 http request 개수 확인</span>
	<span class="n">contexts</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="k">interface</span><span class="p">{})</span> <span class="kt">bool</span> <span class="p">{</span>
		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"status: "</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="s">" count: "</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="k">return</span> <span class="no">true</span>
	<span class="p">})</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="10000개-쿼리-실행-결과110초-소요"><span class="mr-2">10000개 쿼리 실행 결과(110초 소요)</span><a href="#10000개-쿼리-실행-결과110초-소요" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>결과로 빠짐없이 정상 200 code 를 받는것을 확인할 수 있으며, db에도 값에 정상저장되는 것을 확인할 수 있다.</p><ul><li>terminal<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>gyuminhwangbo@Gyuminui-MacBookPro testing % go run main.go 10000
실행시간 110.251228122
status:  200  count:  10000
</pre></table></code></div></div><li>auth DB</ul><p><img data-src="../../assets/img/spring/db5432_auth.png" alt="img" data-proofer-ignore></p><ul><li>chat DB</ul><p><img data-src="../../assets/img/spring/db5434_user.png" alt="img" data-proofer-ignore></p><ul><li>backup DB - chat DB</ul><p><img data-src="../../assets/img/spring/db5433_user.png" alt="img" data-proofer-ignore></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%EC%B1%84%ED%8C%85%EC%84%9C%EB%B2%84-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8/'>채팅서버 프로젝트</a>, <a href='/categories/%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EC%A7%84%ED%96%89/'>프로젝트 진행</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 이 기사는 저작권자의 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 라이센스를 따릅니다.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">공유하기</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%EC%8B%A4%EC%8B%9C%EA%B0%84+%EC%B1%84%ED%8C%85%EB%B0%A9+%EA%B5%AC%ED%98%84%2812%29+-+%28%EB%8C%80%EB%9F%89+Rest+api+test+%ED%95%9C%EA%B3%84+%EB%8F%8C%ED%8C%8C%29+-+Austin&url=%2Fposts%2Fchatting%2812%29%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%EC%8B%A4%EC%8B%9C%EA%B0%84+%EC%B1%84%ED%8C%85%EB%B0%A9+%EA%B5%AC%ED%98%84%2812%29+-+%28%EB%8C%80%EB%9F%89+Rest+api+test+%ED%95%9C%EA%B3%84+%EB%8F%8C%ED%8C%8C%29+-+Austin&u=%2Fposts%2Fchatting%2812%29%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fchatting%2812%29%2F&text=%EC%8B%A4%EC%8B%9C%EA%B0%84+%EC%B1%84%ED%8C%85%EB%B0%A9+%EA%B5%AC%ED%98%84%2812%29+-+%28%EB%8C%80%EB%9F%89+Rest+api+test+%ED%95%9C%EA%B3%84+%EB%8F%8C%ED%8C%8C%29+-+Austin" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="링크 복사하기" data-title-succeed="링크가 복사되었습니다!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">인기 태그</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cs-information/">CS information</a> <a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/backend/">backend</a> <a class="post-tag" href="/tags/error/">error</a> <a class="post-tag" href="/tags/ethereum/">Ethereum</a> <a class="post-tag" href="/tags/msa/">msa</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/restful/">RESTFUL</a> <a class="post-tag" href="/tags/token/">token</a> <a class="post-tag" href="/tags/database/">database</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">바로가기</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>관련된 글</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/chatting(10)/"><div class="card-body"> <em class="small" data-ts="1673136025" data-df="YYYY-MM-DD" > 2023-01-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>실시간 채팅방 구현(10) - (양방향 DB Sync 구현의 어려움 + 비용)</h3><div class="text-muted small"><p> 서론 단방향까지는 구현이 가능했었는데, 양방향(BDR)은 아래의 이유로 굉장히 까다로웠다. 컨셉만 존재할 뿐, 코드 레퍼런스가 없다. 현업자분들께 방향성을 여쭙고싶다. 두 개의 마스터 노드일 때는 그래도 할 순 있겠지만, 그 이상일 때는 각각을 전부다 설정해줘야하기때문에 상당히 까다롭다. ...</p></div></div></a></div><div class="card"> <a href="/posts/chatting(11)/"><div class="card-body"> <em class="small" data-ts="1673740825" data-df="YYYY-MM-DD" > 2023-01-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>실시간 채팅방 구현(11) - (대량 Rest api test 코드)</h3><div class="text-muted small"><p> 현재까지 auth/chat Server 및 여러 장애대응과 모니터링 서비스를 구축했다. 서비스관련 테스트 코드는 이미 생성하였으며, 이제는 다량의 Rest api 트래픽을 테스트를 위한 클라이언트를 제작해 볼 차례이다. 아래의 코드는 Golang으로 제작하였다. 예상되는 아래의 질문에 대한 답변을 준비해봤다. Question : 왜 Java...</p></div></div></a></div><div class="card"> <a href="/posts/chatting(14)/"><div class="card-body"> <em class="small" data-ts="1673913625" data-df="YYYY-MM-DD" > 2023-01-17 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>실시간 채팅방 구현(14) - (대량 Rest api test 자동화)</h3><div class="text-muted small"><p> 실시간 채팅방 backend에 직접 대량의 Rest api test를 진행했었다. 그런데 이 rest api test가 매번 직접 설정해주기 힘들어서 이를 Docker-compose 와 Viper 로 자동화 할 것이다. 아래는 자동화 시키고 실행한 결과를 먼저 보인다. 사용법과 코드는 https://github.com/ghkdqhrbals/multip...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/chatting(11)/" class="btn btn-outline-primary" prompt="이전 글"><p>실시간 채팅방 구현(11) - (대량 Rest api test 코드)</p></a> <a href="/posts/chatting(13)/" class="btn btn-outline-primary" prompt="다음 글"><p>실시간 채팅방 구현(13) - (대량 Rest api test 시 속도문제 해결과정-1)</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">인기 태그</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cs-information/">CS information</a> <a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/backend/">backend</a> <a class="post-tag" href="/tags/error/">error</a> <a class="post-tag" href="/tags/ethereum/">Ethereum</a> <a class="post-tag" href="/tags/msa/">msa</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/restful/">RESTFUL</a> <a class="post-tag" href="/tags/token/">token</a> <a class="post-tag" href="/tags/database/">database</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/ghkdqhrbals">ghkdqhrbals</a>. <span data-toggle="tooltip" data-placement="top" title="명시되지 않는 한 이 사이트의 블로그 게시물은 작성자의 Creative Commons Attribution 4.0 International(CC BY 4.0) 라이선스에 따라 사용이 허가되었습니다.">일부 권리 보유</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">새 버전의 콘텐츠를 사용할 수 있습니다.</p><button type="button" class="btn btn-primary" aria-label="Update"> 업데이트 </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">검색 결과가 없습니다.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-VTR1DF5BPL"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-VTR1DF5BPL'); }); </script>
