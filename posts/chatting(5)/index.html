<!DOCTYPE html><html lang="ko-KR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="실시간 채팅방 구현(5) - (Kafka 연동완료)" /><meta property="og:locale" content="ko_KR" /><meta name="description" content="진행상황 Backend Server 완료 아래는 Kafka Backend Server 세팅 클래스 및 기능들이다. MessageListener : 실제 메세지 내부 로직 수행 KafkaTopicConst : 토픽을 application-properties에서 로드 KafkaTopicConfig : 토픽 등록 KafkaConsumerConfig : 메세지 수신 그룹 및 타입 설정 KafkaProducerConfig : 메세지 발신 설정 KafkaAdminConfig : 카프카 연결" /><meta property="og:description" content="진행상황 Backend Server 완료 아래는 Kafka Backend Server 세팅 클래스 및 기능들이다. MessageListener : 실제 메세지 내부 로직 수행 KafkaTopicConst : 토픽을 application-properties에서 로드 KafkaTopicConfig : 토픽 등록 KafkaConsumerConfig : 메세지 수신 그룹 및 타입 설정 KafkaProducerConfig : 메세지 발신 설정 KafkaAdminConfig : 카프카 연결" /><link rel="canonical" href="/posts/chatting(5)/" /><meta property="og:url" content="/posts/chatting(5)/" /><meta property="og:site_name" content="Austin" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-12-21T00:00:25+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="실시간 채팅방 구현(5) - (Kafka 연동완료)" /><meta name="twitter:site" content="@ghkdqhrbals" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-01-29T08:19:41+00:00","datePublished":"2022-12-21T00:00:25+00:00","description":"진행상황 Backend Server 완료 아래는 Kafka Backend Server 세팅 클래스 및 기능들이다. MessageListener : 실제 메세지 내부 로직 수행 KafkaTopicConst : 토픽을 application-properties에서 로드 KafkaTopicConfig : 토픽 등록 KafkaConsumerConfig : 메세지 수신 그룹 및 타입 설정 KafkaProducerConfig : 메세지 발신 설정 KafkaAdminConfig : 카프카 연결","headline":"실시간 채팅방 구현(5) - (Kafka 연동완료)","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/chatting(5)/"},"url":"/posts/chatting(5)/"}</script><title>실시간 채팅방 구현(5) - (Kafka 연동완료) | Austin</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Austin"><meta name="application-name" content="Austin"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/avatar/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Austin</a></div><div class="site-subtitle font-italic"> Record every seconds</div><div class="site-subtitle"> <a href="https://ghkdqhrbals.github.io/portfolios/" class="mx-auto" style="color: #ffd700"> See my portfolio </a></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>홈</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>카테고리</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>태그</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>아카이브</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>정보</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/ghkdqhrbals" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ghkdqhrbals','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> 홈 </a> </span> <span>실시간 채팅방 구현(5) - (Kafka 연동완료)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 포스트</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="검색..."> </span> <span id="search-cancel" >취소</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4 pb-5"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>실시간 채팅방 구현(5) - (Kafka 연동완료)</h1><div class="post-meta text-muted"> <span> 게시 <em class="" data-ts="1671580825" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-12-21 </em> </span> <span> 업데이트 <em class="" data-ts="1674980381" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2023-01-29 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/ghkdqhrbals">ghkdqhrbals</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1990 단어"> <em>11 분</em>읽는 시간</span></div></div></div><div class="post-content"><h2 id="진행상황"><span class="mr-2">진행상황</span><a href="#진행상황" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="backend-server-완료"><span class="mr-2">Backend Server 완료</span><a href="#backend-server-완료" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>아래는 Kafka Backend Server 세팅 클래스 및 기능들이다.</p><ol><li>MessageListener : 실제 메세지 내부 로직 수행<li>KafkaTopicConst : 토픽을 application-properties에서 로드<li>KafkaTopicConfig : 토픽 등록<li>KafkaConsumerConfig : 메세지 수신 그룹 및 타입 설정<li>KafkaProducerConfig : 메세지 발신 설정<li>KafkaAdminConfig : 카프카 연결</ol><h3 id="테스트login"><span class="mr-2">테스트(Login)</span><a href="#테스트login" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li><p>메세지 전송 <img data-src="../../assets/img/kafka/post.png" alt="img" data-proofer-ignore></p><li><p>메세지 수신</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre> <span class="c"># 직접 메세지 소비</span>
 <span class="o">[</span>appuser@1ec915a5c4a5 ~]<span class="nv">$ </span>kafka-console-consumer <span class="nt">--bootstrap-server</span> localhost:9092 <span class="nt">--topic</span> login-response

 <span class="o">{</span><span class="s2">"userId"</span>:<span class="s2">"a"</span>,<span class="s2">"isSuccess"</span>:true,<span class="s2">"errorMessage"</span>:<span class="s2">""</span>,<span class="s2">"user"</span>:<span class="o">{</span><span class="s2">"userId"</span>:<span class="s2">"a"</span>,<span class="s2">"userPw"</span>:<span class="s2">"1234"</span>,<span class="s2">"email"</span>:<span class="s2">"a@naver.com"</span>,<span class="s2">"userName"</span>:<span class="s2">"user_A"</span>,<span class="s2">"userStatus"</span>:<span class="s2">"바뀐 status message"</span>,<span class="s2">"joinDate"</span>:[2022,12,17],<span class="s2">"loginDate"</span>:[2022,12,22],<span class="s2">"logoutDate"</span>:[2022,12,17]<span class="o">}}</span>
</pre></table></code></div></div></ol><h3 id="kafka-코드"><span class="mr-2">Kafka 코드</span><a href="#kafka-코드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
</pre><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageListener</span> <span class="kd">extends</span> <span class="nc">KafkaTopicConst</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">KafkaTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">kafkaProducerTemplate</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">FriendService</span> <span class="n">friendService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RoomService</span> <span class="n">roomService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ChatService</span> <span class="n">chatService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MessageListener</span><span class="o">(</span><span class="nc">KafkaTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">kafkaProducerTemplate</span><span class="o">,</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">,</span> <span class="nc">FriendService</span> <span class="n">friendService</span><span class="o">,</span> <span class="nc">RoomService</span> <span class="n">roomService</span><span class="o">,</span> <span class="nc">ChatService</span> <span class="n">chatService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">kafkaProducerTemplate</span> <span class="o">=</span> <span class="n">kafkaProducerTemplate</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userService</span> <span class="o">=</span> <span class="n">userService</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">friendService</span> <span class="o">=</span> <span class="n">friendService</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">roomService</span> <span class="o">=</span> <span class="n">roomService</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">chatService</span> <span class="o">=</span> <span class="n">chatService</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 로그인 요청</span>
    <span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="s">"${kafka.topic-login-request}"</span><span class="o">,</span> <span class="n">containerFactory</span> <span class="o">=</span> <span class="s">"loginKafkaListenerContainerFactory"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">listenLogin</span><span class="o">(</span><span class="nc">RequestLoginDTO</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Receive [RequestLoginDTO] Message with userId={},userPw={}"</span><span class="o">,</span><span class="n">req</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span><span class="n">req</span><span class="o">.</span><span class="na">getUserPw</span><span class="o">());</span>

        <span class="nc">ResponseLoginDTO</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span> <span class="n">req</span><span class="o">.</span><span class="na">getUserPw</span><span class="o">());</span>

        <span class="c1">// Kafka 메세지 전송/비동기 처리를 위한 ListenableFuture 사용</span>
        <span class="nc">ListenableFuture</span><span class="o">&lt;</span><span class="nc">SendResult</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">kafkaProducerTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="no">TOPIC_LOGIN_RESPONSE</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span><span class="n">resp</span><span class="o">);</span>
        <span class="n">listenFuture</span><span class="o">(</span><span class="n">future</span><span class="o">);</span> <span class="c1">// 메시지 비동기 callback 처리</span>
    <span class="o">}</span>

    <span class="c1">// 로그아웃 요청</span>
    <span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="s">"${kafka.topic-logout-request}"</span><span class="o">,</span> <span class="n">containerFactory</span> <span class="o">=</span> <span class="s">"logoutKafkaListenerContainerFactory"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">listenLogin</span><span class="o">(</span><span class="nd">@Payload</span> <span class="nc">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ResponseLogoutDTO</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">logout</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>

        <span class="nc">ListenableFuture</span><span class="o">&lt;</span><span class="nc">SendResult</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">kafkaProducerTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="no">TOPIC_LOGOUT_RESPONSE</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="n">resp</span><span class="o">);</span>
        <span class="n">listenFuture</span><span class="o">(</span><span class="n">future</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 유저 참여 채팅방 목록 조회</span>
    <span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="s">"${kafka.topic-user-search-room-request}"</span><span class="o">,</span> <span class="n">containerFactory</span> <span class="o">=</span> <span class="s">"userRoomKafkaListenerContainerFactory"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rooms</span><span class="o">(</span><span class="nc">RequestUserRoomDTO</span> <span class="n">req</span><span class="o">){</span>
        <span class="nc">ResponseUserRoomDTO</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findAllMyRooms</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>

        <span class="nc">ListenableFuture</span><span class="o">&lt;</span><span class="nc">SendResult</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">kafkaProducerTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="no">TOPIC_USER_SEARCH_ROOM_RESPONSE</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span><span class="n">resp</span><span class="o">);</span>
        <span class="n">listenFuture</span><span class="o">(</span><span class="n">future</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 유저의 친구목록 조회</span>
    <span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="s">"${kafka.topic-user-search-friend-request}"</span><span class="o">,</span> <span class="n">containerFactory</span> <span class="o">=</span> <span class="s">"userSearchFriendKafkaListenerContainerFactory"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">findFriend</span><span class="o">(</span><span class="nc">RequestUserFriendDTO</span> <span class="n">req</span><span class="o">){</span>
        <span class="nc">String</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getUserId</span><span class="o">();</span>

        <span class="nc">ResponseUserFriendDTO</span> <span class="n">resp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ResponseUserFriendDTO</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>

        <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">findUser</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">findUser</span><span class="o">.</span><span class="na">isPresent</span><span class="o">()){</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">setStat</span><span class="o">(</span><span class="n">userId</span> <span class="o">+</span> <span class="s">"유저가 존재하지 않습니다"</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Friend</span><span class="o">&gt;</span> <span class="n">friends</span> <span class="o">=</span> <span class="n">friendService</span><span class="o">.</span><span class="na">findAllByUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">setIsSuccess</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">setFriend</span><span class="o">(</span><span class="n">friends</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">ListenableFuture</span><span class="o">&lt;</span><span class="nc">SendResult</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">kafkaProducerTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="no">TOPIC_USER_SEARCH_FRIEND_RESPONSE</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span><span class="n">resp</span><span class="o">);</span>
        <span class="n">listenFuture</span><span class="o">(</span><span class="n">future</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 유저 저장</span>
    <span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="s">"${kafka.topic-user-add-request}"</span><span class="o">,</span> <span class="n">containerFactory</span> <span class="o">=</span> <span class="s">"userAddKafkaListenerContainerFactory"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addUser</span><span class="o">(</span><span class="nc">RequestAddUserDTO</span> <span class="n">req</span><span class="o">){</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span>
                <span class="n">req</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span>
                <span class="n">req</span><span class="o">.</span><span class="na">getUserPw</span><span class="o">(),</span>
                <span class="n">req</span><span class="o">.</span><span class="na">getEmail</span><span class="o">(),</span>
                <span class="n">req</span><span class="o">.</span><span class="na">getUserName</span><span class="o">(),</span>
                <span class="s">""</span><span class="o">,</span>
                <span class="nc">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">(),</span>
                <span class="nc">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">(),</span>
                <span class="nc">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">()</span>
        <span class="o">);</span>

        <span class="nc">ResponseAddUserDTO</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>

        <span class="nc">ListenableFuture</span><span class="o">&lt;</span><span class="nc">SendResult</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">kafkaProducerTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="no">TOPIC_USER_ADD_RESPONSE</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span><span class="n">resp</span><span class="o">);</span>
        <span class="n">listenFuture</span><span class="o">(</span><span class="n">future</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 유저 상태메세지 변경</span>
    <span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="s">"${kafka.topic-user-status-change-request}"</span><span class="o">,</span> <span class="n">containerFactory</span> <span class="o">=</span> <span class="s">"userChangeStatusKafkaListenerContainerFactory"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">changeUserStatus</span><span class="o">(</span><span class="nc">RequestChangeUserStatusDTO</span> <span class="n">req</span><span class="o">){</span>
        <span class="nc">ResponseChangeUserStatusDTO</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">updateUserStatus</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>

        <span class="nc">ListenableFuture</span><span class="o">&lt;</span><span class="nc">SendResult</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span>
                <span class="n">kafkaProducerTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="no">TOPIC_USER_STATUS_CHANGE_RESPONSE</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span><span class="n">resp</span><span class="o">);</span>
        <span class="n">listenFuture</span><span class="o">(</span><span class="n">future</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//채팅방 개설</span>
    <span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="s">"${kafka.topic-user-add-room-request}"</span><span class="o">,</span> <span class="n">containerFactory</span> <span class="o">=</span> <span class="s">"userAddRoomKafkaListenerContainerFactory"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createRoomForm</span><span class="o">(</span><span class="nc">RequestAddUserRoomDTO</span> <span class="n">req</span><span class="o">){</span>
        <span class="nc">ResponseAddUserRoomDTO</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">makeRoomWithFriends</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>

        <span class="nc">ListenableFuture</span><span class="o">&lt;</span><span class="nc">SendResult</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span>
                <span class="n">kafkaProducerTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="no">TOPIC_USER_ADD_ROOM_RESPONSE</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span><span class="n">resp</span><span class="o">);</span>
        <span class="n">listenFuture</span><span class="o">(</span><span class="n">future</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 채팅 저장</span>
    <span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="s">"${kafka.topic-user-add-chat-request}"</span><span class="o">,</span> <span class="n">containerFactory</span> <span class="o">=</span> <span class="s">"userAddChatKafkaListenerContainerFactory"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">chattingRoom</span><span class="o">(</span><span class="nc">RequestAddChatMessageDTO</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Room</span><span class="o">&gt;</span> <span class="n">room</span> <span class="o">=</span> <span class="n">roomService</span><span class="o">.</span><span class="na">findByRoomId</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getRoomId</span><span class="o">());</span>
        <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getWriterId</span><span class="o">());</span>

        <span class="nc">ResponseAddChatMessageDTO</span> <span class="n">resp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ResponseAddChatMessageDTO</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getRoomId</span><span class="o">(),</span><span class="n">req</span><span class="o">.</span><span class="na">getWriterId</span><span class="o">());</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">room</span><span class="o">.</span><span class="na">isPresent</span><span class="o">()){</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">setErrorMessage</span><span class="o">(</span><span class="s">"채팅방이 존재하지 않습니다"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">user</span><span class="o">.</span><span class="na">isPresent</span><span class="o">()){</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">setErrorMessage</span><span class="o">(</span><span class="s">"유저가 존재하지 않습니다"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">Chatting</span> <span class="n">chat</span> <span class="o">=</span> <span class="n">createChatting</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span><span class="n">room</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span><span class="n">req</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">chatService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">chat</span><span class="o">);</span>

        <span class="nc">ListenableFuture</span><span class="o">&lt;</span><span class="nc">SendResult</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span>
                <span class="n">kafkaProducerTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="no">TOPIC_USER_ADD_CHAT_RESPONSE</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getWriterId</span><span class="o">(),</span><span class="n">resp</span><span class="o">);</span>
        <span class="n">listenFuture</span><span class="o">(</span><span class="n">future</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 친구 저장</span>
    <span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="s">"${kafka.topic-user-add-friend-request}"</span><span class="o">,</span> <span class="n">containerFactory</span> <span class="o">=</span> <span class="s">"userAddFriendKafkaListenerContainerFactory"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addFriend</span><span class="o">(</span><span class="nc">RequestAddFriendDTO</span> <span class="n">req</span><span class="o">){</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">friendIds</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getFriendId</span><span class="o">();</span>
        <span class="nc">ResponseAddFriendDTO</span> <span class="n">resp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ResponseAddFriendDTO</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>

        <span class="k">for</span><span class="o">(</span><span class="nc">String</span> <span class="n">friendId</span> <span class="o">:</span> <span class="n">friendIds</span><span class="o">){</span>
            <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">findId</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">friendId</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">findId</span><span class="o">.</span><span class="na">isPresent</span><span class="o">()){</span>
                <span class="n">resp</span><span class="o">.</span><span class="na">setErrorMessage</span><span class="o">(</span><span class="s">"유저가 존재하지 않습니다"</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">friendService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span> <span class="n">friendId</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">ListenableFuture</span><span class="o">&lt;</span><span class="nc">SendResult</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span>
                <span class="n">kafkaProducerTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="no">TOPIC_USER_ADD_FRIEND_RESPONSE</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span><span class="n">resp</span><span class="o">);</span>
        <span class="n">listenFuture</span><span class="o">(</span><span class="n">future</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="c1">// utils</span>
    <span class="kd">private</span> <span class="nc">Chatting</span> <span class="nf">createChatting</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">,</span><span class="nc">Room</span> <span class="n">room</span><span class="o">,</span> <span class="nc">String</span> <span class="n">message</span><span class="o">){</span>
        <span class="nc">Chatting</span> <span class="n">chat</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Chatting</span><span class="o">();</span>
        <span class="n">chat</span><span class="o">.</span><span class="na">setRoom</span><span class="o">(</span><span class="n">room</span><span class="o">);</span>
        <span class="n">chat</span><span class="o">.</span><span class="na">setSendUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">chat</span><span class="o">.</span><span class="na">setCreatedDate</span><span class="o">(</span><span class="nc">ZonedDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">toLocalDate</span><span class="o">());</span>
        <span class="n">chat</span><span class="o">.</span><span class="na">setCreatedTime</span><span class="o">(</span><span class="nc">ZonedDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">toLocalTime</span><span class="o">());</span>
        <span class="n">chat</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">chat</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">listenFuture</span><span class="o">(</span><span class="nc">ListenableFuture</span><span class="o">&lt;</span><span class="nc">SendResult</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">future</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">future</span><span class="o">.</span><span class="na">addCallback</span><span class="o">(</span><span class="k">new</span> <span class="nc">ListenableFutureCallback</span><span class="o">&lt;</span><span class="nc">SendResult</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"메세지 전송 실패 : {}"</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="nc">SendResult</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"메세지 전송 성공 topic: {}, offset: {}, partition: {}"</span><span class="o">,</span><span class="n">result</span><span class="o">.</span><span class="na">getRecordMetadata</span><span class="o">().</span><span class="na">topic</span><span class="o">()</span> <span class="o">,</span><span class="n">result</span><span class="o">.</span><span class="na">getRecordMetadata</span><span class="o">().</span><span class="na">offset</span><span class="o">(),</span> <span class="n">result</span><span class="o">.</span><span class="na">getRecordMetadata</span><span class="o">().</span><span class="na">partition</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">KafkaTopicConst</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-login-request}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_LOGIN_REQUEST</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-login-response}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_LOGIN_RESPONSE</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-logout-request}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_LOGOUT_REQUEST</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-logout-response}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_LOGOUT_RESPONSE</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-search-room-request}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_ROOM_REQUEST</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-search-room-response}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_ROOM_RESPONSE</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-search-room-request}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_SEARCH_ROOM_REQUEST</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-search-room-response}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_SEARCH_ROOM_RESPONSE</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-search-friend-request}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_SEARCH_FRIEND_REQUEST</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-search-friend-response}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_SEARCH_FRIEND_RESPONSE</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-add-request}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_ADD_REQUEST</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-add-response}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_ADD_RESPONSE</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-status-change-request}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_STATUS_CHANGE_REQUEST</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-status-change-response}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_STATUS_CHANGE_RESPONSE</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-add-room-request}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_ADD_ROOM_REQUEST</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-add-room-response}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_ADD_ROOM_RESPONSE</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-add-chat-request}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_ADD_CHAT_REQUEST</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-add-chat-response}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_ADD_CHAT_RESPONSE</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-add-friend-request}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_ADD_FRIEND_REQUEST</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.topic-user-add-friend-response}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="no">TOPIC_USER_ADD_FRIEND_RESPONSE</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">KafkaTopicConfig</span> <span class="kd">extends</span> <span class="nc">KafkaTopicConst</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">KafkaAdmin</span> <span class="n">kafkaAdmin</span><span class="o">;</span>

    <span class="c1">// 계산 잘 해야한다. Partition 개수 &gt;= Group내 Conusmer 개수</span>
    <span class="c1">// 생성하고자 하는 Conumser=2 Partition은 2이기에, 각각 conusmer에게 leader-partition 매칭가능</span>
    <span class="kd">private</span> <span class="nc">NewTopic</span> <span class="nf">generateTopic</span><span class="o">(</span><span class="nc">String</span> <span class="n">topicName</span><span class="o">,</span><span class="kt">int</span> <span class="n">partitionNum</span><span class="o">,</span> <span class="kt">int</span> <span class="n">brokerNum</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">TopicBuilder</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">topicName</span><span class="o">)</span>
                <span class="o">.</span><span class="na">partitions</span><span class="o">(</span><span class="n">partitionNum</span><span class="o">)</span> <span class="c1">// 할당하고자 하는 파티션 개수</span>
                <span class="o">.</span><span class="na">replicas</span><span class="o">(</span><span class="n">brokerNum</span><span class="o">)</span> <span class="c1">// replica sync를 위한 broker 개수</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span> <span class="c1">// 토픽은 총 2개의 leader-partition, 4개의 follow-partition 로 설정할 것임</span>
    <span class="o">}</span>

    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_LOGIN_REQUEST</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>
        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_LOGIN_RESPONSE</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>

        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_LOGOUT_REQUEST</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>
        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_LOGOUT_RESPONSE</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>

        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_ROOM_REQUEST</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>
        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_ROOM_RESPONSE</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>

        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_SEARCH_ROOM_REQUEST</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>
        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_SEARCH_ROOM_RESPONSE</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>

        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_SEARCH_FRIEND_REQUEST</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>
        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_SEARCH_FRIEND_RESPONSE</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>

        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_ADD_REQUEST</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>
        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_ADD_RESPONSE</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>

        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_STATUS_CHANGE_REQUEST</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>
        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_STATUS_CHANGE_RESPONSE</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>

        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_ADD_ROOM_REQUEST</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>
        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_ADD_ROOM_RESPONSE</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>

        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_ADD_CHAT_REQUEST</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>
        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_ADD_CHAT_RESPONSE</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>

        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_ADD_FRIEND_REQUEST</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>
        <span class="n">kafkaAdmin</span><span class="o">.</span><span class="na">createOrModifyTopics</span><span class="o">(</span><span class="n">generateTopic</span><span class="o">(</span><span class="no">TOPIC_USER_ADD_FRIEND_RESPONSE</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="nd">@EnableKafka</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">KafkaProducerConfig</span> <span class="o">{</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.bootstrap-servers}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">bootstrapServer</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">ProducerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">producerFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">configProps</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">configProps</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ProducerConfig</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span> <span class="n">bootstrapServer</span><span class="o">);</span>
        <span class="n">configProps</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ProducerConfig</span><span class="o">.</span><span class="na">KEY_SERIALIZER_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">StringSerializer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">configProps</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ProducerConfig</span><span class="o">.</span><span class="na">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">JsonSerializer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nc">DefaultKafkaProducerFactory</span><span class="o">&lt;&gt;(</span><span class="n">configProps</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">KafkaTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">kafkaProducerTemplate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">KafkaTemplate</span><span class="o">&lt;&gt;(</span><span class="n">producerFactory</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
</pre><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@EnableKafka</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">KafkaConsumerConfig</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.bootstrap-servers}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">bootstrapServer</span><span class="o">;</span>

    <span class="c1">// 로그인 요청</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">RequestLoginDTO</span><span class="o">&gt;</span> <span class="nf">loginKafkaListenerContainerFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getContainerFactory</span><span class="o">(</span><span class="s">"defaultGroup"</span><span class="o">,</span><span class="nc">RequestLoginDTO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 로그아웃</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">logoutKafkaListenerContainerFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getContainerFactory</span><span class="o">(</span><span class="s">"defaultGroup"</span><span class="o">,</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 유저 참여 채팅방 목록 조회</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">RequestUserRoomDTO</span><span class="o">&gt;</span> <span class="nf">userRoomKafkaListenerContainerFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getContainerFactory</span><span class="o">(</span><span class="s">"defaultGroup"</span><span class="o">,</span><span class="nc">RequestUserRoomDTO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 유저 친구목록 조회</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">RequestUserFriendDTO</span><span class="o">&gt;</span> <span class="nf">userSearchFriendKafkaListenerContainerFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getContainerFactory</span><span class="o">(</span><span class="s">"defaultGroup"</span><span class="o">,</span><span class="nc">RequestUserFriendDTO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 유저 저장</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">RequestAddUserDTO</span><span class="o">&gt;</span> <span class="nf">userAddKafkaListenerContainerFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getContainerFactory</span><span class="o">(</span><span class="s">"defaultGroup"</span><span class="o">,</span><span class="nc">RequestAddUserDTO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 유저 상태메세지 변경</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">RequestChangeUserStatusDTO</span><span class="o">&gt;</span> <span class="nf">userChangeStatusKafkaListenerContainerFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getContainerFactory</span><span class="o">(</span><span class="s">"defaultGroup"</span><span class="o">,</span><span class="nc">RequestChangeUserStatusDTO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 채팅방 개설</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">RequestAddUserRoomDTO</span><span class="o">&gt;</span> <span class="nf">userAddRoomKafkaListenerContainerFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getContainerFactory</span><span class="o">(</span><span class="s">"defaultGroup"</span><span class="o">,</span><span class="nc">RequestAddUserRoomDTO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 채팅 저장</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">RequestAddChatMessageDTO</span><span class="o">&gt;</span> <span class="nf">userAddChatKafkaListenerContainerFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getContainerFactory</span><span class="o">(</span><span class="s">"defaultGroup"</span><span class="o">,</span><span class="nc">RequestAddChatMessageDTO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 유저 친구 저장</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">RequestAddFriendDTO</span><span class="o">&gt;</span> <span class="nf">userAddFriendKafkaListenerContainerFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getContainerFactory</span><span class="o">(</span><span class="s">"defaultGroup"</span><span class="o">,</span><span class="nc">RequestAddFriendDTO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 유틸 목록 - 제네릭 클래스로 여러메소드에서 중복사용가능하도록 유틸화하였다.
     * --Methods--
     * getContainerFactory()
     * getKafkaConsumerFactory()
     * setConfig()
     * setDeserializer()
     */</span>

    <span class="kd">private</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nf">getContainerFactory</span><span class="o">(</span><span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">classType</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;&gt;();</span>
        <span class="n">factory</span><span class="o">.</span><span class="na">setConsumerFactory</span><span class="o">(</span><span class="n">getKafkaConsumerFactory</span><span class="o">(</span><span class="n">groupId</span><span class="o">,</span> <span class="n">classType</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">factory</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">DefaultKafkaConsumerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nf">getKafkaConsumerFactory</span><span class="o">(</span><span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">classType</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">JsonDeserializer</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">deserializer</span> <span class="o">=</span> <span class="n">setDeserializer</span><span class="o">(</span><span class="n">classType</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">DefaultKafkaConsumerFactory</span><span class="o">&lt;&gt;(</span><span class="n">setConfig</span><span class="o">(</span><span class="n">groupId</span><span class="o">,</span> <span class="n">deserializer</span><span class="o">),</span> <span class="k">new</span> <span class="nc">StringDeserializer</span><span class="o">(),</span> <span class="n">deserializer</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">ImmutableMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">setConfig</span><span class="o">(</span><span class="nc">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="nc">JsonDeserializer</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">deserializer</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ImmutableMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">config</span> <span class="o">=</span> <span class="nc">ImmutableMap</span><span class="o">.&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span><span class="n">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ConsumerConfig</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span> <span class="n">bootstrapServer</span><span class="o">)</span>
                <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ConsumerConfig</span><span class="o">.</span><span class="na">KEY_DESERIALIZER_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">StringDeserializer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ConsumerConfig</span><span class="o">.</span><span class="na">GROUP_ID_CONFIG</span><span class="o">,</span> <span class="n">groupId</span><span class="o">)</span>
                <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ConsumerConfig</span><span class="o">.</span><span class="na">VALUE_DESERIALIZER_CLASS_CONFIG</span><span class="o">,</span> <span class="n">deserializer</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">config</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">JsonDeserializer</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">setDeserializer</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">classType</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">JsonDeserializer</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">deserializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JsonDeserializer</span><span class="o">&lt;&gt;(</span><span class="n">classType</span><span class="o">);</span>
        <span class="n">deserializer</span><span class="o">.</span><span class="na">setRemoveTypeHeaders</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="n">deserializer</span><span class="o">.</span><span class="na">addTrustedPackages</span><span class="o">(</span><span class="s">"*"</span><span class="o">);</span>
        <span class="n">deserializer</span><span class="o">.</span><span class="na">setUseTypeMapperForKey</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">deserializer</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">KafkaAdminConfig</span> <span class="o">{</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${kafka.bootstrap-servers}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">bootstrapServer</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">KafkaAdmin</span> <span class="nf">kafkaAdmin</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">configs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">configs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">AdminClientConfig</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span> <span class="n">bootstrapServer</span><span class="o">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">KafkaAdmin</span><span class="o">(</span><span class="n">configs</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>이 밖에 많은수의 데이터 발신/수신 포멧들과 서비스들이 연계되어 사용된다.</p><h3 id="frontend-server-진행중"><span class="mr-2">Frontend Server 진행중</span><a href="#frontend-server-진행중" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Backend 개발 이후 세션과 페이지를 관리하는 Frontend Server을 개발중에 있다. 이 과정에서 고려할 몇가지를 추가하려 한다.</p><ul><li><strong>Server-Sent Event로 진행</strong></ul><p>이전 계획은 Frontend Server에서 webClient로 HTTP 비동기-nonBlocking 수신하려하였지만, backend에서 HTTP를 통하지 않고 직접 토픽 내 메세지 수신으로 바꾸었기에 수정이 필요하다.</p><p>수정 이후 예상되는 전체 flow는 다음과 같다.</p><blockquote><p>수정된 Flow(로그인 예시)</p><ol><li>클라이언트 브라우저에서 GET /login FrontServer에 전송.<li>Front Server에서 SSE 모델 전송 및 유저인증 메시지 Kafka에 login-request 토픽으로 전달<li>클라이언트 브라우저에서 SSE 이벤트 수신 이전 로그인 로딩창 확인<li>Backend Server에서 Kafka메세지 수신 및 인증로직 수행 이후 login-response 토픽에 전달<li>Front Server는 이를 수신 및 SSE 이벤트 클라이언트 브라우저에 전달<li>클라이언트는 비로소 로그인 성공화면 redirect</ol></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%EC%B1%84%ED%8C%85%EC%84%9C%EB%B2%84-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8/'>채팅서버 프로젝트</a>, <a href='/categories/%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EC%A7%84%ED%96%89/'>프로젝트 진행</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 이 기사는 저작권자의 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 라이센스를 따릅니다.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">공유하기</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%EC%8B%A4%EC%8B%9C%EA%B0%84+%EC%B1%84%ED%8C%85%EB%B0%A9+%EA%B5%AC%ED%98%84%285%29+-+%28Kafka+%EC%97%B0%EB%8F%99%EC%99%84%EB%A3%8C%29+-+Austin&url=%2Fposts%2Fchatting%285%29%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%EC%8B%A4%EC%8B%9C%EA%B0%84+%EC%B1%84%ED%8C%85%EB%B0%A9+%EA%B5%AC%ED%98%84%285%29+-+%28Kafka+%EC%97%B0%EB%8F%99%EC%99%84%EB%A3%8C%29+-+Austin&u=%2Fposts%2Fchatting%285%29%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fchatting%285%29%2F&text=%EC%8B%A4%EC%8B%9C%EA%B0%84+%EC%B1%84%ED%8C%85%EB%B0%A9+%EA%B5%AC%ED%98%84%285%29+-+%28Kafka+%EC%97%B0%EB%8F%99%EC%99%84%EB%A3%8C%29+-+Austin" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="링크 복사하기" data-title-succeed="링크가 복사되었습니다!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">인기 태그</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cs-information/">CS information</a> <a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/backend/">backend</a> <a class="post-tag" href="/tags/error/">error</a> <a class="post-tag" href="/tags/ethereum/">Ethereum</a> <a class="post-tag" href="/tags/msa/">msa</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/restful/">RESTFUL</a> <a class="post-tag" href="/tags/token/">token</a> <a class="post-tag" href="/tags/database/">database</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">바로가기</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>관련된 글</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/chatting(10)/"><div class="card-body"> <em class="small" data-ts="1673136025" data-df="YYYY-MM-DD" > 2023-01-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>실시간 채팅방 구현(10) - (양방향 DB Sync 구현의 어려움 + 비용)</h3><div class="text-muted small"><p> 서론 단방향까지는 구현이 가능했었는데, 양방향(BDR)은 아래의 이유로 굉장히 까다로웠다. 컨셉만 존재할 뿐, 코드 레퍼런스가 없다. 현업자분들께 방향성을 여쭙고싶다. 두 개의 마스터 노드일 때는 그래도 할 순 있겠지만, 그 이상일 때는 각각을 전부다 설정해줘야하기때문에 상당히 까다롭다. ...</p></div></div></a></div><div class="card"> <a href="/posts/chatting(11)/"><div class="card-body"> <em class="small" data-ts="1673740825" data-df="YYYY-MM-DD" > 2023-01-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>실시간 채팅방 구현(11) - (대량 Rest api test 코드)</h3><div class="text-muted small"><p> 현재까지 auth/chat Server 및 여러 장애대응과 모니터링 서비스를 구축했다. 서비스관련 테스트 코드는 이미 생성하였으며, 이제는 다량의 Rest api 트래픽을 테스트를 위한 클라이언트를 제작해 볼 차례이다. 아래의 코드는 Golang으로 제작하였다. 예상되는 아래의 질문에 대한 답변을 준비해봤다. Question : 왜 Java...</p></div></div></a></div><div class="card"> <a href="/posts/chatting(12)/"><div class="card-body"> <em class="small" data-ts="1673740825" data-df="YYYY-MM-DD" > 2023-01-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>실시간 채팅방 구현(12) - (대량 Rest api test 한계 돌파)</h3><div class="text-muted small"><p> INDEX 랜덤값으로 test하는 code 10000개 rest api 트래픽 실행(110초 소요) 이제 동시 연결가능한 TCP 소켓을 필자의 맥북이 버틸 수 있는만큼 열어서 다량의 http request를 서버로 전송해볼려고 한다. 1 2 3 4 5 6 7 8 9 10 t := http.DefaultTransport.(*http.Tr...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/chatting(4)/" class="btn btn-outline-primary" prompt="이전 글"><p>실시간 채팅방 구현(4) - (프로젝트 수행시 고려점3)</p></a> <a href="/posts/chatting(6)/" class="btn btn-outline-primary" prompt="다음 글"><p>실시간 채팅방 구현(6) - (전체 아키텍처 수정)</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">인기 태그</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cs-information/">CS information</a> <a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/backend/">backend</a> <a class="post-tag" href="/tags/error/">error</a> <a class="post-tag" href="/tags/ethereum/">Ethereum</a> <a class="post-tag" href="/tags/msa/">msa</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/restful/">RESTFUL</a> <a class="post-tag" href="/tags/token/">token</a> <a class="post-tag" href="/tags/database/">database</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/ghkdqhrbals">ghkdqhrbals</a>. <span data-toggle="tooltip" data-placement="top" title="명시되지 않는 한 이 사이트의 블로그 게시물은 작성자의 Creative Commons Attribution 4.0 International(CC BY 4.0) 라이선스에 따라 사용이 허가되었습니다.">일부 권리 보유</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">새 버전의 콘텐츠를 사용할 수 있습니다.</p><button type="button" class="btn btn-primary" aria-label="Update"> 업데이트 </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">검색 결과가 없습니다.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-VTR1DF5BPL"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-VTR1DF5BPL'); }); </script>
